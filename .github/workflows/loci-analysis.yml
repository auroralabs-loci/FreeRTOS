name: LOCI Integration Demo
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to checkout'
        required: true
        default: 'main'
        type: string

jobs:  
  FREERTOS-LOCI:
    name: FreeRTOS with LOCI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 'FreeRTOS' repository
        uses: actions/checkout@v5
      
      - name: Checkout 'FreeRTOS' submodules
        run: git submodule update --checkout --init --depth 1 CMSIS_6 mbed-os FreeRTOS/Source

      - name: Install GNU ARM Toolchain
        shell: bash
        run: |
          sudo apt-get -y update
          sudo apt-get -y install gcc-arm-none-eabi build-essential cmake git ninja-build python3-minimal

      - name: Build CORTEX_MPU_M4_MPS2_QEMU_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_MPU_M4_MPS2_QEMU_GCC
        run: make -j
  
      - name: FreeRTOS demo (upload)
        uses: auroralabs-loci/loci-action@v1.0.1
        env:
          LOCI_BACKEND_URL: '${{ vars.LOCI_DEV_BACKEND_URL }}'
          LOCI_API_KEY: '${{ secrets.LOCI_DEV_AGENTIC_API_KEY }}'
        with:
          mode: upload
          project: FreeRTOS CM4
          binaries: |
                FreeRTOS/Demo/CORTEX_MPU_M4_MPS2_QEMU_GCC/build/RTOSDemo.axf

      - name: FreeRTOS demo (summary)
        uses: auroralabs-loci/loci-action@v1.0.1
        env:
          LOCI_BACKEND_URL: '${{ vars.LOCI_DEV_BACKEND_URL }}'
          LOCI_API_KEY: '${{ secrets.LOCI_DEV_AGENTIC_API_KEY }}'
        with:
          mode: summary
          project: FreeRTOS CM4