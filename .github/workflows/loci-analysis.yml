name: LOCI Integration Demo
on:
  workflow_dispatch:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [ main ]
  push:
    branches: [ main ]


jobs:  
  FREERTOS-LOCI:
    name: FreeRTOS with LOCI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 'FreeRTOS' repository
        uses: actions/checkout@v5
        with:
          submodules: recursive # Fetch submodules

      - name: Install GNU ARM Toolchain
        shell: bash
        run: |
          sudo apt-get -y update
          sudo apt-get -y install gcc-arm-none-eabi build-essential cmake git ninja-build python3-minimal

      - name: Build CORTEX_MPU_M4_MPS2_QEMU_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_MPU_M4_MPS2_QEMU_GCC
        run: make -j
  
      - name: FreeRTOS demo (upload)
        uses: auroralabs-loci/loci-action@v1.0.1
        env:
          LOCI_BACKEND_URL: '${{ vars.LOCI_DEV_BACKEND_URL }}'
          LOCI_API_KEY: '${{ secrets.LOCI_DEV_AGENTIC_API_KEY }}'
        with:
          mode: upload
          project: FreeRTOS CM4
          binaries: |
                FreeRTOS/Demo/CORTEX_MPU_M4_MPS2_QEMU_GCC/build/RTOSDemo.axf

      - name: FreeRTOS demo (summary)
        uses: auroralabs-loci/loci-action@v1.0.1
        env:
          LOCI_BACKEND_URL: '${{ vars.LOCI_DEV_BACKEND_URL }}'
          LOCI_API_KEY: '${{ secrets.LOCI_DEV_AGENTIC_API_KEY }}'
        with:
          mode: summary
          project: FreeRTOS CM4